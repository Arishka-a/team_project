name: Epic PR Sync
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  update-epic:
    if: contains(github.head_ref, 'epic/')
    runs-on: ubuntu-latest
    steps:
      - name: Update Epic Description
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const repo = context.repo;
            const epicBranch = pr.head.ref;

            const { data: childPRs } = await github.rest.pulls.list({
              owner: repo.owner,
              repo: repo.repo,
              state: 'open',
              base: epicBranch
            });

            let body = pr.body || '';
            let childSection = '### Подзадачи:\n';
            for (const child of childPRs) {
              if (child.number === pr.number) continue;
              const status = child.merged ? 'Closed' : 'Open';
              childSection += `- [!${child.html_url}] ${child.title} [ ] (${status})\n`;
            }

            if (!body.includes('### Подзадачи:')) {
              body += '\n\n' + childSection;
            } else {
              body = body.replace(/### Подзадачи:[\s\S]*/m, childSection);
            }

            await github.rest.pulls.update({
              owner: repo.owner,
              repo: repo.repo,
              pull_number: pr.number,
              body: body
            });
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}